# =============================================================================
# Urocissa Docker Compose (多模式整合版)
# =============================================================================

# 1. 定義共用設定 (Base Config)
# 這裡使用 YAML 的錨點 (&base-config) 來避免重複寫一大堆 volumes 設定
x-base-config: &base-config
  restart: unless-stopped
  
  # 固定容器內路徑
  environment:
    - UROCISSA_PATH=/urocissa
  
  # 讀取後端設定檔
  env_file:
    - ../backend/.env

  # 連接埠 (預設 5673)
  ports:
    - "5673:5673"

  # 掛載目錄
  volumes:
    # --- 核心設定檔 ---
    - ../backend/.env:/urocissa/backend/.env:ro
    - ../backend/Rocket.toml:/urocissa/backend/Rocket.toml:ro
    - ../backend/config.json:/urocissa/backend/config.json:ro
    
    # --- 資料儲存 ---
    - ../backend/db:/urocissa/backend/db
    - ../backend/object:/urocissa/backend/object

    # =======================================================================
    # [使用者設定區] 請在這邊加入您的照片路徑
    # =======================================================================
    # - /path/to/your/photos:/path/to/your/photos:ro


services:
  # ===========================================================================
  # 模式 1: 穩定版 (Stable)
  # 使用指令: docker compose up stable
  # ===========================================================================
  stable:
    <<: *base-config            # 繼承上方的共用設定
    image: hsa00000/urocissa:latest
    container_name: urocissa-stable
    profiles: ["stable"]        # 加入 profile 防止直接 up 全部啟動

  # ===========================================================================
  # 模式 2: 開發版 (Dev) - 這是您目前想測試的版本
  # 使用指令: docker compose up dev
  # ===========================================================================
  dev:
    <<: *base-config
    image: hsa00000/urocissa:dev
    container_name: urocissa-dev
    profiles: ["dev"]

  # ===========================================================================
  # 模式 3: 本地編譯 (Local Build) - 修改程式碼後使用
  # 使用指令: docker compose up local
  # ===========================================================================
  local:
    <<: *base-config
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        BUILD_TYPE: debug      # 這裡已經幫您寫死用 debug 模式編譯
    container_name: urocissa-local
    profiles: ["local"]