services:
  urocissa:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_TYPE=debug
    image: urocissa:local
    container_name: urocissa
    restart: unless-stopped

    # 設定環境變數
    # 這裡將 UROCISSA_PATH 固定為容器內的 /run/urocissa，這與宿主機的真實路徑無關，
    # 但會作為容器內程式運作的根目錄。
    environment:
      - UROCISSA_PATH=/run/urocissa
      - ROCKET_PORT=4000 # 確保容器內 Rocket 監聽此 Port (需與 Rocket.toml 一致)

    # 載入 .env 檔案中的變數 (主要是為了讓程式讀取，非 Compose 設定用)
    env_file:
      - ./gallery-backend/.env

    # Port 對應：[宿主機]:[容器]
    # 如果你在 Rocket.toml 修改了 port，這裡也要跟著修改
    ports:
      - "4000:4000"

    volumes:
      # ---------------------------------------------------------
      # 核心設定檔與資料庫 (對應 run_urocissa_docker.sh 的行為)
      # ---------------------------------------------------------
      # 1. 環境變數檔
      - ./gallery-backend/.env:/run/urocissa/gallery-backend/.env

      # 2. Rocket 設定檔 (Web Server 設定)
      - ./gallery-backend/Rocket.toml:/run/urocissa/gallery-backend/Rocket.toml

      # 3. 應用程式設定檔
      - ./gallery-backend/config.json:/run/urocissa/gallery-backend/config.json

      # 4. 資料庫檔案 (持久化儲存)
      - ./gallery-backend/db:/run/urocissa/gallery-backend/db

      # 5. 物件儲存 (縮圖、預覽圖等)
      - ./gallery-backend/object:/run/urocissa/gallery-backend/object

      # ---------------------------------------------------------
      # [重要] 外部相簿路徑 (SYNC_PATH)
      # ---------------------------------------------------------
      # 原本的 Script 會自動讀取 .env 中的 SYNC_PATH 並掛載。
      # 在 Docker Compose 中，你必須手動在此處新增。
      # 格式為: - 宿主機絕對路徑:容器內絕對路徑
      #
      # 範例 (假設你的 .env 裡 SYNC_PATH="/home/user/photos")：
      # - /home/user/photos:/home/user/photos